version: '3'

# IMPORTANT: Before using this docker-compose file, start the tunnel manually:
# socat TCP-LISTEN:8080,reuseaddr,fork EXEC:"$(pwd)/../src/bin/tunnel.sh" &

services:
  lumier:
    image: lumier:latest  # or trycua/lumier:latest if using the Docker Hub image
    container_name: lumier-vm
    restart: unless-stopped
    ports:
      - "8006:8006"  # Port for VNC access
    volumes:
      - ../storage:/storage  # VM persistent storage (relative path from docker-compose.yml)
      - ../shared:/data     # Shared folder accessible in the VM
    environment:
      - VM_NAME=lumier-vm
      - VERSION=ghcr.io/trycua/macos-sequoia-vanilla:latest  # Default MacOS image
      - CPU_CORES=4  # Number of CPU cores
      - RAM_SIZE=8192  # RAM in MB
      - HOST_STORAGE_PATH=${PWD}/../storage  # Required for Docker-only setup
      - HOST_SHARED_PATH=${PWD}/../shared     # Required for Docker-only setup
      - LUMIER_DEBUG=0  # Set to 1 for debug mode
    # Network mode host is optional but can improve performance
    # network_mode: host
    
    # Uncomment the following lines if needed for KVM virtualization
    # devices:
    #  - /dev/kvm
    #  - /dev/net/tun
    stop_signal: SIGINT
    stop_grace_period: 2m

# Note: When using Docker Compose for Lumier, you're responsible for:
# - Starting and managing the tunnel (using socat as shown above)
# - Building the Docker image before first use (docker-compose build)
# - Providing the correct environment variables (HOST_STORAGE_PATH and HOST_SHARED_PATH)
#
# To stop the tunnel when done:
# 1. Find the process: lsof -i TCP:8080
# 2. Kill it by PID: kill <PID>
#
# Access the VM via VNC at: http://localhost:8006/vnc.html
# The password will be displayed in the logs (docker-compose logs)
